<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MadeReal | Admin Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: { black: '#000000', teal: '#00D2A0', gray: '#F5F5F7' }
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; background-color: #F5F5F7; }
        .hidden { display: none !important; }
        textarea { font-family: monospace; }
    </style>
</head>
<body class="text-black h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="w-full bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center shrink-0">
        <div class="text-xl font-black tracking-tight">made<span class="text-brand-teal">real</span> <span class="text-gray-400 font-medium text-sm ml-2">Admin</span></div>
        <button id="logoutBtn" class="hidden text-sm font-medium text-gray-500 hover:text-black transition"><i class="fas fa-sign-out-alt mr-2"></i>Sign Out</button>
    </nav>

    <!-- Login View -->
    <div id="loginView" class="flex-1 flex items-center justify-center p-6">
        <div class="bg-white p-10 rounded-2xl shadow-xl max-w-md w-full text-center border border-gray-100">
            <h2 class="text-3xl font-black mb-2">Admin Access</h2>
            <p class="text-gray-500 mb-8 text-sm">Restricted to maderealdesign@gmail.com</p>
            <button id="loginBtn" class="w-full bg-black text-white py-3 rounded-full font-bold hover:bg-gray-800 transition shadow-lg flex items-center justify-center gap-3">
                <i class="fab fa-google"></i> Sign in with Google
            </button>
            <p id="loginError" class="text-red-500 text-sm mt-4 font-medium hidden"></p>
        </div>
    </div>

    <!-- Dashboard View -->
    <div id="dashboardView" class="hidden flex-1 flex flex-col p-6 max-w-5xl mx-auto w-full">
        <div class="flex justify-between items-end mb-8">
            <div>
                <h1 class="text-3xl font-black">Previews</h1>
                <p class="text-gray-500 text-sm mt-1">Manage client dynamic sites</p>
            </div>
            <button id="createNewBtn" class="bg-brand-teal text-white px-6 py-3 rounded-full font-bold shadow-lg hover:bg-teal-500 transition flex items-center gap-2">
                <i class="fas fa-plus"></i> New Preview
            </button>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden flex-1 flex flex-col">
            <ul id="previewList" class="divide-y divide-gray-100 overflow-y-auto">
                <!-- List items injected via JS -->
                <li class="p-8 text-center text-gray-400 font-medium" id="emptyState">Loading previews...</li>
            </ul>
        </div>
    </div>

    <!-- Editor Modal -->
    <div id="editorModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                <h2 class="text-2xl font-black" id="modalTitle">Create Preview</h2>
                <button id="closeModalBtn" class="text-gray-400 hover:text-black"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-6 flex-1 overflow-hidden flex flex-col gap-4">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">URL Slug</label>
                    <div class="flex items-center">
                        <span class="bg-gray-100 border border-r-0 border-gray-300 px-4 py-3 rounded-l-lg text-gray-500 text-sm font-medium">madereal.uk/</span>
                        <input type="text" id="slugInput" placeholder="e.g. arc-joinery" class="flex-1 border border-gray-300 rounded-r-lg px-4 py-3 focus:outline-none focus:border-brand-teal focus:ring-1 focus:ring-brand-teal">
                    </div>
                </div>
                <div class="flex-1 flex flex-col min-h-[300px]">
                    <label class="block text-sm font-bold text-gray-700 mb-1">HTML Code</label>
                    <textarea id="htmlInput" class="w-full flex-1 border border-gray-300 rounded-lg p-4 focus:outline-none focus:border-brand-teal focus:ring-1 focus:ring-brand-teal text-sm bg-gray-50" placeholder="Paste full HTML code here..."></textarea>
                </div>
            </div>
            <div class="p-6 border-t border-gray-100 flex justify-end gap-3 bg-gray-50 rounded-b-2xl">
                <button id="cancelBtn" class="px-6 py-2.5 rounded-full font-bold text-gray-600 hover:bg-gray-200 transition">Cancel</button>
                <button id="saveBtn" class="px-6 py-2.5 rounded-full font-bold bg-black text-white hover:bg-gray-800 transition shadow-lg flex items-center gap-2">
                    <i class="fas fa-save"></i> Save & Publish
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Setup -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";

        // ==========================================
        // FIREBASE CONFIG - UPDATED
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyAxmpbvmgyb831MMi2HA7Nd7c18wCb1m1c",
            authDomain: "maderealwebsites.firebaseapp.com",
            projectId: "maderealwebsites",
            storageBucket: "maderealwebsites.firebasestorage.app",
            messagingSenderId: "179002605066",
            appId: "1:179002605066:web:8fd2218624a3d41064a9f3",
            measurementId: "G-V0HREJWLX0"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        const ALLOWED_EMAIL = "maderealdesign@gmail.com";

        // UI Elements
        const loginView = document.getElementById('loginView');
        const dashboardView = document.getElementById('dashboardView');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const loginError = document.getElementById('loginError');
        const previewList = document.getElementById('previewList');
        
        // Modal Elements
        const editorModal = document.getElementById('editorModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const saveBtn = document.getElementById('saveBtn');
        const createNewBtn = document.getElementById('createNewBtn');
        const slugInput = document.getElementById('slugInput');
        const htmlInput = document.getElementById('htmlInput');
        const modalTitle = document.getElementById('modalTitle');

        let isEditing = false;
        let originalSlug = "";

        // Auth Logic
        onAuthStateChanged(auth, (user) => {
            if (user && user.email === ALLOWED_EMAIL) {
                loginView.classList.add('hidden');
                dashboardView.classList.remove('hidden');
                logoutBtn.classList.remove('hidden');
                loadPreviews();
            } else if (user) {
                // Wrong email
                signOut(auth);
                showError("Access denied. Unauthorized email.");
            } else {
                loginView.classList.remove('hidden');
                dashboardView.classList.add('hidden');
                logoutBtn.classList.add('hidden');
            }
        });

        loginBtn.addEventListener('click', async () => {
            try { await signInWithPopup(auth, provider); } 
            catch (error) { showError(error.message); }
        });

        logoutBtn.addEventListener('click', () => signOut(auth));

        function showError(msg) {
            loginError.textContent = msg;
            loginError.classList.remove('hidden');
        }

        // Dashboard Logic
        async function loadPreviews() {
            previewList.innerHTML = '<li class="p-8 text-center text-gray-400 font-medium"><i class="fas fa-spinner fa-spin mr-2"></i>Loading...</li>';
            try {
                const q = query(collection(db, "previews"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    previewList.innerHTML = '<li class="p-8 text-center text-gray-400 font-medium">No previews found. Create your first one!</li>';
                    return;
                }

                previewList.innerHTML = '';
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const li = document.createElement('li');
                    li.className = "p-4 md:p-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 hover:bg-gray-50 transition";
                    li.innerHTML = `
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-brand-teal/10 flex items-center justify-center text-brand-teal font-bold"><i class="fas fa-globe"></i></div>
                            <div>
                                <h3 class="font-bold text-lg text-slate-900">${doc.id}</h3>
                                <a href="/${doc.id}" target="_blank" class="text-sm text-blue-500 hover:underline">madereal.uk/${doc.id}</a>
                            </div>
                        </div>
                        <div class="flex gap-2 w-full md:w-auto">
                            <button onclick="window.editPreview('${doc.id}')" class="flex-1 md:flex-none px-4 py-2 rounded-lg font-semibold text-sm bg-gray-100 hover:bg-gray-200 transition text-gray-700"><i class="fas fa-pen mr-1"></i> Edit</button>
                            <button onclick="window.deletePreview('${doc.id}')" class="flex-1 md:flex-none px-4 py-2 rounded-lg font-semibold text-sm bg-red-50 hover:bg-red-100 transition text-red-600"><i class="fas fa-trash mr-1"></i> Delete</button>
                        </div>
                    `;
                    previewList.appendChild(li);
                });
            } catch (e) {
                previewList.innerHTML = `<li class="p-8 text-center text-red-500 font-medium">Error loading data: ${e.message}</li>`;
            }
        }

        // Modal Logic
        function openModal(editMode = false, slug = "", html = "") {
            isEditing = editMode;
            originalSlug = slug;
            slugInput.value = slug;
            htmlInput.value = html;
            modalTitle.textContent = editMode ? "Edit Preview" : "Create New Preview";
            editorModal.classList.remove('hidden');
        }

        function closeModal() {
            editorModal.classList.add('hidden');
            slugInput.value = '';
            htmlInput.value = '';
        }

        createNewBtn.addEventListener('click', () => openModal(false));
        closeModalBtn.addEventListener('click', closeModal);
        cancelBtn.addEventListener('click', closeModal);

        saveBtn.addEventListener('click', async () => {
            let slug = slugInput.value.trim().toLowerCase().replace(/[^a-z0-9-]/g, '-');
            const html = htmlInput.value.trim();

            if (!slug || !html) return alert('Please provide both a slug and HTML code.');

            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            saveBtn.disabled = true;

            try {
                // If editing and slug changed, delete the old document
                if (isEditing && slug !== originalSlug) {
                    await deleteDoc(doc(db, "previews", originalSlug));
                }

                // Save new/updated document using slug as the Document ID
                await setDoc(doc(db, "previews", slug), {
                    slug: slug,
                    html: html,
                    createdAt: serverTimestamp()
                });

                closeModal();
                loadPreviews();
            } catch (e) {
                alert('Error saving: ' + e.message);
            } finally {
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Save & Publish';
                saveBtn.disabled = false;
            }
        });

        // Expose to window for inline onclick handlers
        window.editPreview = async (slug) => {
            const docRef = doc(db, "previews", slug);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                openModal(true, docSnap.id, docSnap.data().html);
            } else {
                alert("Document not found!");
            }
        };

        window.deletePreview = async (slug) => {
            if(confirm(`Are you sure you want to delete /${slug}? This cannot be undone.`)) {
                try {
                    await deleteDoc(doc(db, "previews", slug));
                    loadPreviews();
                } catch (e) {
                    alert("Error deleting: " + e.message);
                }
            }
        };
    </script>
</body>
</html>